= Установка комплекса программ для разработки баз данных
:lab: 1
:discipline: Базы данных

== Предисловие
Из-за отсутствия установочных файлов Oracle XE для дистрибутивов linux ориентированных на debian
был выбран следующий набор инструментов:

- https://www.postgresql.org/[PostgreSQL] -- СУБД с поддержкой индексов, нескольких баз данных, системы доступа, sequences.
В рамках лабораторных работ покрывает функционал Oracle, за исключением преднастроенных учебных данных.
- https://www.jetbrains.com/datagrip/[JetBrains DataGrip] -- клиент для графического доступа к СУБД, дающий возможность отобразить схему БД в виде диаграммы.
Предоставляет функционал аналогичный Oracle SQL Developer, за исключением графического создания схем.
- https://retool.com[Retool] -- online-инструмент для прототипирования графических интерфейсов, имеющий возможность взаимодействия с БД.
Аналогичен Oracle Application Express.
- https://ngrok.com[Ngrok] -- динамический прокси сервер. Будет использоваться в 3 лабораторной работе для соединения Retool с локальной БД.
- https://www.docker.com/[Docker] -- система контейнеризации и дистрибьюции приложений. Используется для установки PostgreSQL

Набор инструментов обладает функционалом для выполнения заданий из всех 3 лабораторных работ, но не имеет методических указаний.

== Установка
=== PostgreSQL

Для установки используется следующая команда:

[source,shell]
----
docker run --name postgres-bmstu <1>
  -v $(pwd)/pg:/var/lib/postgresql/data <2>
  -e POSTGRES_PASSWORD=password <3>
  -p 5432:5432 <4>
  postgres:12 <5>
----

<1> -- запускается контейнер с именем `postgres-bmstu`;
<2> -- файлы с данными СУБД будут хранится в дериктории `./pg`;
<3> -- через переменную окружения задаётся пароль пользователя `postgres` (аналогичен пользователю ROOT);
<4> -- порт `5432`, открытый внутри контейнера становится доступным по адресу `localhost:5432` вне контейнера;
<5> -- используется образ postgres последней 12-ой версии.

=== DataGrip
Для установки DataGrip испольузется менеджер установщик программ https://www.jetbrains.com/toolbox-app/[JetBrains Toolbox]

image::toolbox.png[]
image::toolbox-install.png[]

== Запуск. Доступ к БД
Для запуска PostgreSQL используем команду:
[source,shell]
docker start postgres-bmstu

В DataGrip добавляем новый источник данных, указываем в настройках хоста `localhost:5432` и в настройках пользователя `postgres:password`:

image::dg-settings.png[]

== Создание тестовой БД
Для проверки работоспособности установленной СУБД создаётся БД под названием metro и заполняется 3 табличками: рабочие, депо, станции.

Создаётся всё это с помощью следующего скрипта:
[[table_struct,Структура таблиц]]
[source,sql]
----
CREATE DATABASE metro;


include::pgsql/postgres_public_depo.sql[]


include::pgsql/postgres_public_stations.sql[]


include::pgsql/postgres_public_workers.sql[]
----


== Простейшее администрирование
Для задачи администрирования создаётся пользователь `retool` для доступа к СУБД программы Retool.

Для этого надо выполнить следующий код:
[source,sql]
----
create user retool with password 'retool-Pass';

grant select on all tables in schema public to retool;
----

Команда создаёт пользователя retool с паролем и даёт ему права на получение данных из всех несистемных таблиц в бд.

== Получение доступа к БД из Retool
Для доступа к СУБД надо запустить ngrok:
[source,shell]
ngrok tcp 5432

Команда выдаёт внешний хост и порт `tcp://0.tcp.ngrok.io:11220`.

В Retool во вкладке "Resources" создаём новый PostgreSQL:

image::retool-resource.png[]

== Контрольные вопросы

. *Какие таблицы есть в схеме?*
В схеме есть таблицы depo, stations, workers, которые содержат депо, станции и работников метро соответственно.

image::schema.png[]

[start=2]
. *Какие связи есть между таблицами?*
Таблицы `stations` и `workers` связаны с таблицей `depo` как Многое-к-одному (Many-to-One). Ещё таблица workers связывается сама с собой через `reports_to:id`, реализуя древовидное подчинение.
. *Укажите все ключи, которые присутствуют в данной схеме.*
В каждой таблице схемы есть *первичный ключ* -- `id`.
В таблице `depo` так же _мог быть_ *вторичный ключ* -- их номер Тяговой Части (ТЧ-1, ТЧ-2 и т.д.).
В таблице `stations` вторичным ключом _мог быть_ номер архитектурного проекта.
Внешним ключом в таблицах `stations` и `workers` является `depo_id`, зывающий на первичный ключ в `depo`.
Так же в `workers` есть "внешний" ключ `reports_to`, указывающий на id этой же таблицы `workers`.
. *Что такое представления? Какие есть представления?*
Представления -- таблицы, являющиеся результатом выборки из другой таблицы или представления.
В данном случае представлением может быть, например, таблица со всеми рабочими, прикреплёнными к ТЧ-1 "Северное":

[source,sql]
----
CREATE VIEW depo_severnoe_workers AS
    SELECT *
    FROM workers
    WHERE depo_id = 1;
----

[start=5]
. *Что такое индекс? Приведите код индексов.*
Индекс -- структура, оптимизирующая операции с определёнными колонками, по которым он построен.

[source,sql]
----
CREATE unique index workers_pk
    on workers (id);
----

[start=6]
. *Покажите стркутуру таблицы*. Стркутуру таблицы можно увидеть в <<table_struct>>

== Вывод
Был получен опыт установки и настройки СУБД.
